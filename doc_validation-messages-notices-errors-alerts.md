## Ideally:  
### 1.
Errors are always written in `/config/locales/en.yml` and `/config/locales/devise.en.yml`  

Always displayed through bootstrap.
Except when the page requires `js` to work, in which case the errors can be written in the corresponding `js` file.
For the analytics environment variable, we take something from ruby and insert it into a `js` variable which would enable us to take errors from `i18n`, and use them in `js`

### 2.
User feedback messages and possibly certain errors, are always in one of two places on the front-end:
* In line with form field labels (through bootstrap)  
* In a container at the top of the page (through haml/css)

The ones generated by devise are in **container**  
The ones generated by rails are in **wrapper** (wrapper contains container)  
**Solution:** any flash message appears in its own container

An example of a user feedback message is on the **manage items** page:
flash a message saying **Your item was removed from the Community,** when a user performs that action

---
## Contents
 * [TYPE 1](#type-1) 
 * [TYPE 2](#type-2)
 * [TYPE 3](#type-3)
 * [TYPE 4](#type-4)
 * [SUCCESS AND NOTICE DISPLAY](#success-and-notice-display)
 * [ERROR DISPLAY](#error-display)

---

### TYPE 1:
>**Messages**

`theglassfiles_com/app/assets/stylesheets/application.css.scss`

```
// message, notice, error display
```
```
#flash_success { 
	background-color: $green-dark_color;
	color: $white_color;
	a {
		color: $white_color;
		text-decoration: underline;
	}
}
```

```
#flash_notice {
	@extend #flash_success;
}
```

```
#flash_guidance {
	@extend #flash_success;
}
```

```
#flash_alert { 
	color: red;
}
```

---

### TYPE 2:
>**label_errors => true**  
**inline_errors => true**

**Validation Errors**
  `theglassfiles_com/config/locales/en.yml`

```  
en:
  activerecord:
    errors:
      models:
        user:
          attributes:
            name_first:
              blank: "is required"
            email:
              blank: "is required"
              invalid: "is not a valid email address"
              taken: "already belongs to a member of The Glass Files"
            password:
              blank: "is required"
              too_short: "is too short: the required minimum is 8 characters"
            password_confirmation:
              confirmation: "does not match password"
        group:
          attributes:
            name:
              blank: "is required"
            town:
              blank: "is required"
```

**Devise Errors**  
`theglassfiles_com/config/locales/devise.en.yml`  
`theglassfiles_com/app/views/devise/registrations/new.html.haml`

``` 
= bootstrap_form_for(resource,
                     :as => resource_name,
                     :url => registration_path(resource_name),
                     :html => { :class => 'form-vertical' },
                     :label_errors => true) do |f| 
```
  
`theglassfiles_com/app/controllers/users/registrations_controller.rb`

``` 
def update_email
  new_email = params[:user][:email]

  # current_user.password_bypass = true

  if current_user.update_without_password(email: new_email)
    # sign_in current_user, bypass: true
    flash[:success] = 'Your email address was changed successfully.'
    redirect_to manage_accounts_path
  else
    current_user.reload
    render :edit_email
  end
end
```

```
def update_password
  if current_user.update_with_password(update_password_params)
    sign_in current_user, bypass: true
    flash[:success] = 'Your password was changed successfully.'
    redirect_to manage_accounts_path
  else
    current_user.reload
    render :edit_password
  end
end
```
  
`theglassfiles_com/app/models/user.rb`

```
validates_presence_of :name_first
#                     :password_confirmation
#                     :subdomain
```
  
`theglassfiles_com/app/views/devise/sessions/new.html.haml`

``` 
= bootstrap_form_for(resource, 
                    :as => resource_name, 
                    :url => session_path(resource_name), 
                    :html => {:class => 'form-vertical' }, 
                    :inline_errors => true) do |f|

      = f.email_field :email, autofocus: true, label: "Email address"
      
      = f.password_field :password
      
      /= f.error_summary
      
      /= f.check_box :remember_me                    
      
      = f.content_tag :div, "", class: 'container_button' do 
          .btn-group
              = f.submit 'Enter', class: "btn btn-md btn-primary"

              %a{:href => "/auth/facebook"}
                  .btn.btn-md.btn-secondary{style: "padding: 6px 6px; font-size: 20px;"}
                      Enter with Facebook
              %a{:href => "/auth/google"}
                  .btn.btn-md.btn-secondary{style: "padding: 6px 6px; font-size: 20px;"}
                      Enter with Google

          = f.content_tag :div, raw("If you've lost your password, you can #{ link_to "reset your password here",  new_password_path(resource_name), class: 'turn_bold' }.<br>To create your free Personal account, #{ link_to "click here to register", new_registration_path(resource_name), class: 'turn_bold' }."), class: 'button_disclaimer'

      /= @user.errors.full_messages               
```

---

### TYPE 3:
>**Starts in javascript, ends in javascript**

`theglassfiles_com/app/assets/javascripts/images.js`

```
  function display_error(label_for, error_text) {
    var label = $("[for='" + label_for + "']");
    var error_message = label.text().split(" - ")[0] + " - " + error_text;
    label.parent().addClass('has-error');
    label.text(error_message);
    scrollTo(label);
  }
```

```
  //form front-end validation
  function validate_form() {
    var invalid = [];
    invalid[1] = validate_description_short();
    setTimeout(function() {
      invalid[0] = validate_file_presence();
    }, 1450);
    // invalid[2] = validate_input_file_type();
    // invalid[3] = validate_input_file_size();
    return invalid;
}
```

```
  function validate_description() {
    if ($('#image_description').val().length > 10000) {
      display_error(LABEL_DESCRIPTION, ERROR_DESCRIPTION_TOO_LONG);
      return false;
    }

    clear_error(LABEL_DESCRIPTION);
    return true;
  }
```

```
  $('#image_description').parent().focusout(function() {
    if (validate_description()) {
      clear_error(LABEL_ORIGINAL)
      $('#image_description').parent().removeClass('has-error');
    }
  });
```

---

### TYPE 4:

>`stripe / create group / payment form`

`theglassfiles_com/app/views/groups/new.html.haml`

```
= bootstrap_nested_form_for @account, url: groups_path(@group), html: {id: 'account'}, label_errors: true do |f|        
        
      = f.fields_for :group, Group.new, label_errors: true do |g|

        = g.text_field :name, maxlength: 30, autofocus: false, label: "Family name", class: "control-label required", placeholder: "Family name"
        
        = g.text_field :town, maxlength: 51, placeholder: "example: The Bronx, NY, USA", autofocus: false, label: "Town of Family origin", help: raw("A place that is very important to your family history. This could be a place of family gathering, or a<br> town where many family members live or are originally from.<br> <span class='turn_italic'>Examples:</span><br><span class='turn_bold'>Springfield, MA, USA</span><br><span class='turn_bold'>Timbuktu, Mali</span>")          

      .container_payment_options
        #account_payment_plan.control-label
          * Select your payment option:
        
        = f.content_tag :div, class: 'container_checkbox' do
          = f.content_tag :div, class: 'form-check' do
            = radio_button("account", "payment_method", "monthly")
          = f.content_tag :label, raw("Pay <span class='turn_bold paint_red'>$2</span> <span class='turn_bold'>every month</span>"), for: "account_payment_method_monthly"

        = f.content_tag :div, class: 'container_checkbox' do
          = f.content_tag :div, class: 'form-check' do
            = radio_button("account", "payment_method", "one-time", { checked: "checked" })
          = f.content_tag :label, raw("Pay <span class='turn_bold paint_red'>$90</span> <span class='turn_bold'>once</span> for eternal access"), for: "account_payment_method_one-time"

      = f.content_tag :div, class: 'form-group' do
        = image_tag("icons_payment_methods.png", style: "width: 690px;", alt: "Security certificate || The Glass Files") 


      #flash-messages
``` 

### SUCCESS AND NOTICE DISPLAY
 * `assets / javascripts / manage`
 * `assets / javascripts / groups`
 * `controllers / users / registrations`
 * `controllers / media_items`
 * `controllers / accounts`
 * `controllers / groups`
 * `controllers / images`
 * `controllers / writings`
 * `views / browse / index`
 * `views / manage / manage families`
 * `views / manage / manage items`
 * `views / manage / manage accounts`

**To Render Messages**  
  The partial `app/views/layouts/_display_messages.html.haml` can be used to display any flash messages you create.

```
   = render 'layouts/messages'
```

This partial appears below the header. It calls `app/views/layouts/_messages.html.erb`

```
<% if flash.any? %>
<div class="container">
<% flash.each_with_index do |(key, value), index| %>
  <% if value.class == Array %>
    <% value.each do |message| %>
      <div class="flash_message" id="flash_<%= key %>">
        <%= message.html_safe %>
      </div>
    <% end %>
  <% else %>
    <div class="flash_message" id="flash_<%= key %>">
      <%= value.html_safe %>
    </div>
  <% end %>

  <%# clears the error so it doesn't appear on every subsequent page you go to %>
  <% flash.clear%>

<% end %>
</div>
<% end %>
```

You can use `render 'layouts/_messages'` anywhere in your view to display messages.

In some cases, it is possible that there will be two flash messages displayed on the same page. In such cases, the display hierarchy is:
1. The result of the action you just took
2. The special case you find yourself in

=============================

##### `assets / javascripts / manage`

```
var ERROR_EMAIL_INVALID = "Email address is not a valid email address";

// manage families view members
function handle_role_click(role_button, group_id, member_id, role, url) {
  if ($(role_button).hasClass("js_member")) grant_role_ajax(role_button, group_id, member_id, role, url);
  else {
      var r = confirm("Are you sure you want to proceed?");

      if (r == true) revoke_role_ajax(role_button, group_id, member_id, role, url);
  }
}
```

```
function handle_remove_from_group_click(member_id, html_url) {
  var r = confirm("Are you sure you want to proceed?");
  if (r == true) remove_from_group_ajax(member_id, html_url);
}
```

```
// handle leave family or organization
function handle_leave_group_click(leave_action, url, member_id, group_name) {
  var r = confirm("Are you sure you want to leave this Family?");
  if (r == true) leave_group_ajax(member_id, url);
}
```

```
function leave_group_ajax(member_id, link) {
  $.ajax({
    type: 'DELETE',
    url: link,
    data: {
      member_id: member_id
    },
    beforeSend: function(xhr) {
      xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))
    },
    success: function(data, a, response_object) {
      // successful request; do something with the data
      window.location.replace(response_object.responseText)
    },
    error: function() {
      // failed request; give feedback to user
    }
  });
}
```

```
// delete item
function handle_delete_item(item_id, html_url) {
  var r = confirm("Are you sure you want to delete this media item?");
  if (r == true) delete_item_ajax(item_id, html_url);
}

```

=============================


##### `assets / javascripts / groups`
```
show_error = function(message) {
  $("#flash-messages").html('<div id="flash_alert" class="flash_message" style="margin-bottom: 60px;">' + 'All entries must be accurate.' + '</div>');
  // document.getElementById("form_description").style.color = "blue";
  // document.getElementById("credit_card_number").style.color = "#ff0000";
  // document.getElementsByTagName("label").style.color = "#ff0000";
  // document.getElementById("credit_card_name").style.color = "#ff0000";
  // document.getElementById("credit_card_zip").style.color = "#ff0000";
  // document.getElementById("credit_card_exp_date").style.color = "#ff0000";
  // document.getElementById("credit_card_exp_year").style.color = "#ff0000";
  // document.getElementById("credit_card_code").style.color = "#ff0000";
  return false;
};
```

=============================

##### `controllers / users / registrations`

```
update_email
      flash[:success] = 'Your email address was changed successfully.'
```

```
update_password
      flash[:success] = 'Your password was changed successfully.'
```

=============================

##### `controllers / media_items`

```
create
      flash[:success] = 'Your media item is now saved in your library.'
```

```
update
      flash[:success] = 'You successfully updated the details of your media item.'
```

```
destroy
      flash[:success] = 'You have deleted the media item you selected.'
```

=============================


##### `controllers / accounts`
```
create
      flash[:success] = 'You created your Family account successfully!'
```

```
update
      flash[:success] = 'You updated your Family account successfully.'
```

```
destroy
      flash[:success] = 'You deleted a Family account. Would you like to <a href="#{create_families_path}">create a new one</a>?'
```

```
update_payment_card
      flash[:success] = 'Your updated credit card information is approved.'
```

```
update_user_password
      flash[:success] = 'Your password was changed successfully.'
```

```
update_user_email
      flash[:success] = 'Your email address was changed successfully.'
```

```
update_group_name_town
      flash[:success] = 'You changed your Family account information successfully.'
```

```
update_user_name_town
      flash[:success] = 'You changed your Personal account information successfully.'
```

```
update_profile_picture
      flash[:success] = "Your #{group_id != 0 ? "#{group.group_type}'s " : ""}profile picture was changed successfully."
```

=============================


##### `controllers / groups`

```
grant_group_role

      if group.add(member, as: role)
        # Notify this user they made someone a manager.
        Notification.create(notification_type: :you_designated_them_historian,
          other_user_id: member.id,
          group_id: group.id,
          user_id: current_user.id
        )

        # Notify the other user they are now a manager.
        Notification.create(
          notification_type: :they_designated_you_historian,
          other_user_id: current_user.id,
          group_id: group.id,
          user_id: member.id
        )

        Mailer.they_designated_you_historian(member, group, current_user).deliver_later

        format.html {render :nothing => true, :notice => 'We sent a notification of your request to #{member.name}.'}
      else
        flash[:alert] = "We were not able to fulfill your request. Please notify us of this issue by emailing <a href='mailto:customerservice@theglassfiles.com'>customerservice@theglassfiles.com</a>"
        format.html {render nothing: true}
      end
```

```
revoke_group_role

      if group.users.delete(member, as: role)
        # Notify this user they revoked someone as manager.
        Notification.create(
          notification_type: :you_revoked_them_historian,
          other_user_id: member.id,
          group_id: group.id,
          user_id: current_user.id
        )
        # Notify the other user they are no longer a manager.
        Notification.create(
          notification_type: :they_revoked_you_historian,
          other_user_id: current_user.id,
          group_id: group.id,
          user_id: member.id
        )

        Mailer.they_revoked_you_historian(member, group, current_user).deliver_later

        format.html {render :nothing => true, :notice => 'We sent a notification of your action to #{member.name}.'}
      else
        flash[:alert] = "Your profile picture was not changed"
        render manage_accounts_view
      end
```

```
remove_group_user

      if group.users.delete(member)

        if member == current_user
          flash[:success] = "You have left the #{group.name} Family."
          Notification.create(
            notification_type: :you_left_group,
            user_id: current_user.id,
            group_id: group.id
          )

          # Notify every manager and admin
          notifications = User.in_group(group).as([:manager, :admin]).map do |user|
            Notification.new(
              notification_type: :they_left_group,
              user_id: user.id,
              group_id: group.id,
              other_user_id: member.id
            )
          end

          if notifications.any? then Notification.import(notifications, timestamps: false) end
        
        else
          flash[:success] = "You removed #{member.name} from the #{group.name} Family."
          Notification.create(
            notification_type: :they_removed_you_group,
            other_user_id: current_user.id,
            user_id: member.id,
            group_id: group.id
          )
          Mailer.they_removed_you_group(member, group, current_user).deliver_later

          Notification.create(
            notification_type: :you_removed_them_group,
            other_user_id: member.id,
            user_id: current_user.id,
            group_id: group.id
          )
        
        end


        # format.html {redirect_to "/manage/families", notice: "You removed #{member.name_first} from the #{group.name} Family."}
        format.html {render text: "#{manage_families_url}"}
      else
        flash[:alert] = "We were not able to fulfill your request. Please notify us of this issue by emailing <a href='mailto:customerservice@theglassfiles.com'>customerservice@theglassfiles.com</a>"
        format.html {redirect_to "/manage/families"}
      end
```

```
create

    respond_to do |format|
      url = manage_families_dynamic_url(@account.group.id, "invite_members", "invitemembers")
      flash[:success] = "You created your Family group successfully! Now <a href='#{url}'>invite members to it</a>."

      format.html {redirect_to manage_families_dynamic_path(@account.group.id, "invite_members", ""), success: 'You created your Family group successfully.'}
    end
```

```
manage_families

    if @form == "view_members"      
      ifif @form == "view_members"
      if (@curr_group.users(as: :member) +  @curr_group.users(as: :manager) +  @curr_group.users(as: :admin)).count > 1
        @members = @curr_group.get_group_members(current_user)
      else
        respond_to do |format|
          url = manage_families_dynamic_url(@curr_group.id, "invite_members", "invitemembers")
          flash[:success] = "You don't have any family members yet. <a href='#{url}'>Invite members now</a>!"

          redirect_to manage_families_dynamic_path(@curr_group.id, "invite_members", "")
          return
        end
      end
    elsif @form == "edit_picture"
      page = [1, group_manage_params[:page].to_i].max
      all = Group.get_items(g_id, { number_of_items: 60, page: page, user: current_user })

      if all['items'].empty?
        flash[:notice] = "This Family doesn't have any items yet. <a href=#{manage_default_path}>Share some now</a>!"

        redirect_to manage_families_path(:anchor => "")
        return
      else
        @entries = all['items']
        @total_pages = all['pages']
        @curr_page = all['curr_page']
        @pagination_url_parameters = { form: @form, group_id: g_id }
        @url_fragment = "changepicture"
        @is_managing_accounts = false

        @entries.push(Image.new(id: -42, file_original_file_name: "avatar_#{@curr_group.group_type.downcase}_thumbnail.png")) if @curr_page == @total_pages
      end
    end

```

=============================

##### `controllers / browse`

```
tag

      flash[:notice] = "There are no items with the tag you selected."
```

=============================


##### `controllers / images`

```
create
      flash[:success] = 'Your media item is now saved in your library.'
```

```
update
      flash[:success] = 'You successfully updated the details of your media item.'
```

```
historian_update_sharings

      if in_group && !@image.in_group?(group)
        if gid == Group::WORLD_ID || gid == Group::COMMUNITY_ID
          format.html { render :nothing => true, :notice => "The item you selected is no longer shared with the #{group.name} group." }
        else
          flash[:success] = "The item you selected is no longer shared with the #{group.name} group."
          format.html { redirect_to manage_path_group(gid, "#browse"), success: 'The item you selected is no longer shared with the #{group.name} group.' }
        end
      elsif !in_group && @image.in_group?(group)
        format.html { render :nothing => true, :notice => "The item you selected is now shared with the #{group.name} group. Nice!" }
      else
        flash[:alert] = "We were not able to fulfill your request. Please notify us of this issue by emailing <a href='mailto:customerservice@theglassfiles.com'>customerservice@theglassfiles.com</a>"
        format.html { render nothing: true }
      end
```

```
destroy

    if @image.destroy
      Notification.create(
        notification_type: :you_deleted_item,
        user_id: current_user.id,
        media_type: @image.media_type
      )

      respond_to do |format|
        flash[:success] = 'You have deleted the media item you selected.'
        format.html { render text: "#{manage_items_url}", success: 'You have deleted the media item you selected.' }
        format.json { head :no_content }
      end
    else
      respond_to do |format|
        format.html { redirect_to images_url, alert: 'You do not have permission to delete this media item.' }
        format.json { head :no_content }
      end
    end
```

=============================


##### `controllers / writings`

```
create
      flash[:success] = 'Your media item is now saved in your library.'
```

```
update
      flash[:success] = 'You successfully updated the details of your media item.'
```

```
historian_update_sharings

      if in_group && !@writing.in_group?(group)
        if gid == Group::WORLD_ID || gid == Group::COMMUNITY_ID
          format.html { render :nothing => true, :notice => "The item you selected is no longer shared with the #{group.name} group." }
        else
          flash[:success] = "The item you selected is no longer shared with the #{group.name} group."
          format.html { redirect_to manage_path_group(gid, "#browse"), success: 'The item you selected is no longer shared with the #{group.name} group.' }
        end
      elsif !in_group && @writing.in_group?(group)
        format.html { render :nothing => true, :notice => "The item you selected is now shared with the #{group.name} group. Nice!" }
      else
        flash[:alert] = "We were not able to fulfill your request. Please notify us of this issue by emailing <a href='mailto:customerservice@theglassfiles.com'>customerservice@theglassfiles.com</a>"
        format.html { render nothing: true }
      end
```

```
destroy

    if @writing.destroy then
      Notification.create(
        notification_type: :you_deleted_item,
        user_id: current_user.id,
        media_type: @writing.media_type
      )

      respond_to do |format|
        flash[:success] = 'You have deleted the media item you selected.'
        format.html { render text: "#{manage_items_url}", success: 'You have deleted the media item you selected.' }
        format.json { head :no_content }
      end
    else
      respond_to do |format|
        format.html { redirect_to writings_url, alert: 'You do not have permission to delete this media item.' }
        format.json { head :no_content }
      end
    end
```

=============================


##### `views / browse / index`

```
.flash_message

#flash_notice
You haven't created any media items yet. <a href="#{create_items_landing_url}">Create your first item now</a>!

#flash_notice
No one has shared items with this family yet. <a href="#{manage_items_group_id_path(0)}">Share your first item now</a>!

#flash_guidance
Click or tap a circle to see items shared by members of that group.
```

=============================


##### `views / browse / tag`


```
.container
    .flash_message{:id => "flash_notice"}
        These items have the '#{@tag_name}' tag.
```

=============================


##### `views / manage / manage families`

```
.flash_message

#flash_notice
You have not yet created or joined families. <a href="#{create_families_url}">Create a family today</a>!

#flash_guidance
Each circle represents a group you're a part of.
```

=============================


##### `views / manage / manage items`

```
.flash_message

#flash_notice
You haven't created any media items yet. <a href="#{create_items_landing_url}">Create your first item now</a>!

#flash_notice
You haven't shared any items with the Community.

#flash_notice
You haven't shared any items with the World.

#flash_notice
This Family doesn't have any items yet. <a href="#{manage_default_path}">Share some now</a>!

#flash_guidance
Click or tap a circle to see items you can manage in that group.
```

=============================


##### `views / manage / manage accounts`  

```
.flash_message

#flash_guidance
Administer your personal account and the groups you've created.
```

---

### ERROR DISPLAY
 * `flash-messages`
 * `flash_error`
 * `flash_alert`
 * `flash_notice (success)`
 * `flash_guidance (user guidelines)`
 * `phrasing of error/success messages`  

---
  
```
views with messages displayed by rendering 'layouts/display_messages' 
  devise/sessions/new.html.haml
  devise/registrations/edit_email.html.haml
  devise/registrations/edit_password.html.haml
```

----

`groups/new`
  
Within `groups/new` is a Stripe form to create an account.
This form's error messages are controlled by Stripe javascript.

----

For the following forms, some error messages are generated by a javascript file and others are called by the controllers.

```  
  media_items/new
  media_items/update
  media_items/destroy
  
  slideshows/new
  slideshows/update
  slideshows/destroy
  
  videos/new
  videos_items/update
  videos_items/destroy
  
  writings/new
  writings/update
  writings/destroy
```

----

```
Views with rails-generated errors on the form, which can be overridden by en.yml
  devise/passwords/new.html.haml
  devise/passwords/edit.html.haml
  devise/registrations/edit.html.haml
```
---

**Not Logged In:**

register  
`app/views/devise/registrations/new.html.haml`  

reset password + reset password url (2 step process)  
`app/views/devise/passwords/new.html.haml`  
`app/views/devise/passwords/edit.html.haml`  
  
login  
`app/views/devise/sessions/new.html.haml`  

----

**Logged In:**

Payment (`create group/family`)  
TODO  

Change password  
`app/views/devise/registrations/_edit_password.html.haml`  

Change email address  
`app/views/devise/registrations/_edit_email.html.haml`  


---

phrasing of error/success messages  
rails validation (register)  
http://guides.rubyonrails.org/i18n.html  

----

{ legacy NYCNAK }  
phrasing of error messages  
simpleform validation  
`config/locales/simple_form.en.yml`  

----
